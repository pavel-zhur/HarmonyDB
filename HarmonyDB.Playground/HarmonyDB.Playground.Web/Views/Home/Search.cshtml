@using System.Text.Json
@using HarmonyDB.Index.Api.Model.VExternal1
@using OneShelf.Common.Api.Client
@model SearchModel

@{
    ViewBag.Title = "Search";
    Layout = "_Layout";

    SearchResponse? response = ViewBag.Response;
    ApiTraceBag? trace = ViewBag.Trace;
}

<div>
    <h3 class="d-inline-block">Search</h3>
    @Html.ActionLink("\ud83d\udd17Permalink", "Search", "Home", Model with
    {
        JustForm = true,
    }, null)
</div>

@using (Html.BeginForm("Search", "Home", Model, FormMethod.Get))
{
    <p>
        Progression: @Html.TextBoxFor(x => x.Query)
    </p>
    <p>
        Ordering:
        <label>
            @Html.RadioButtonFor(x => x.Ordering, SearchRequestOrdering.ByCoverage)
            By Coverage
        </label>
        
        <label>
            @Html.RadioButtonFor(x => x.Ordering, SearchRequestOrdering.ByRating)
            By Rating
        </label>
    </p>
    <p>
        Min coverage (real, 0&ndash;1): @Html.TextBoxFor(x => x.MinCoverage)
    </p>
    <p>
        Min rating (integer, 0&ndash;100): @Html.TextBoxFor(x => x.MinRating)
    </p>
    <p>
        Songs Per Page: @Html.TextBoxFor(x => x.SongsPerPage)
    </p>
    <p>
        <label>
            @Html.CheckBoxFor(x => x.IncludeTrace)
            Include the Index API trace for developers
        </label>
    </p>
    <input type="submit" value="Search" />
}

@if (response != null)
{
    <div class="mt-4">
        <h3 class="d-inline-block">Results</h3>
        @Html.ActionLink("\ud83d\udd17Permalink", "Search", "Home", Model, null)
    </div>

    @await Html.PartialAsync("Paging", Model)

    <table>
        <thead>
        <tr>
            <td>Artists</td>
            <td>Title</td>
            <td>Source</td>
            <td>Rating</td>
            <td>Coverage</td>
        </tr>
        </thead>
        @foreach (var song in response.Songs)
        {
            <tr>
                <td>@string.Join(", ", song.Header.Artists ?? Enumerable.Empty<string>())</td>
                <td>@song.Header.Title</td>
                <td>@song.Header.Source</td>
                <td>@((int)song.Header.Rating)%</td>
                <td>@((int)(song.Coverage * 100))%</td>
            </tr>
        }
    </table>

    @await Html.PartialAsync("Paging", Model)
}

@if (trace != null)
{
    <h3 class="mt-4">Trace</h3>
    @foreach (var request in trace.Requests)
    {
        <h4>@request.Method @request.Url</h4>
        @if (request.Request != null)
        {
            <p>
                Request:
                <pre>@JsonSerializer.Serialize(request.Request, new JsonSerializerOptions { WriteIndented = true, })</pre>
            </p>
        }
        @if (request.Response != null)
        {
            <p>
                Request:
                <pre>@JsonSerializer.Serialize(request.Response, new JsonSerializerOptions { WriteIndented = true, })</pre>
            </p>
        }
        <p>
            Time taken: @request.TimeTaken
        </p>
    }
}